# Vault Auditing to stdout

This example shows how to output [Vault's](https://vaultproject.io) audit log to stdout in Kubernetes. Technically it's a Docker problem, but Kubernetes is a popular and useful platform to demonstrate the solution on.

## The problem
1. We want to output Vault's ["file" audit backend](https://www.vaultproject.io/docs/audit/file.html) to stdout.
2. In Docker, you can't [simply log to stdout](https://github.com/moby/moby/issues/19616) by outputting to `/dev/stdout`. There are recommendations to [symlink to or directly output to `/proc/1/fd/1`](https://github.com/moby/moby/issues/19616#issuecomment-174355979), but this appears to only work if the container doesn't run as `root`.
3. The [official vault container](https://hub.docker.com/_/vault/) runs as user `vault`, not `root`, so we need another solution.

## Workaround
`Mkfifo` to the rescue! This is my first experience w/ `mkfifo`, so I can't describe it as well as [this page does](https://linux.die.net/man/3/mkfifo). It allows us to create a file that streams to stdout. In the following code (borrowed from [this github issue comment](https://github.com/moby/moby/issues/6880#issuecomment-220637337), we create a "FIFO special file" at `tmp/logpipe`:
```
mkfifo -m 600 /tmp/logpipe
cat <> /tmp/logpipe 1>&2 &
```

Then we set Vault's file audit backend to write to this file. Then the logs show up in `kubernetes logs` and for [Google Container Engine](https://cloud.google.com/container-engine/) in [Stackdriver](https://cloud.google.com/stackdriver/).

## Try it out
Once you have a Kubernetes cluster up and running, run:
```
kubectl apply -f pod.yaml
```

If you take a look at the vault-server logs you should see the audit logs, being generated by the dummy `vault-client` container.
```
kubectl logs -f vault-audit-stackdriver vault-server
```